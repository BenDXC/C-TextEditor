release:
  runs-on: ubuntu-latest
  needs: build
  if: github.event_name == 'push' && github.ref == 'refs/heads/main'

  steps:
    # Step 1: Checkout the code again, fetch all tags
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all tags

    # Step 2: Set up Git configuration for tagging
    - name: Set up Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    # Step 3: Get the latest tag and generate the next version
    - name: Get the latest tag and generate the next version
      id: version
      run: |
        LATEST_TAG=$(git tag --sort=-creatordate | head -n 1)
        if [ -z "$LATEST_TAG" ]; then
          MAJOR=0
          MINOR=1
          PATCH=0
        else
          VERSION=$(echo $LATEST_TAG | sed 's/^v//')
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          PATCH=$((PATCH + 1))
        fi

        NEW_TAG="v$MAJOR.$MINOR.$PATCH"
        echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

    # Step 4: Create the changelog and update the release notes
    - name: Generate Changelog
      run: |
        git log $LATEST_TAG..HEAD --oneline > changelog.md
        echo "Changelog for $NEW_TAG" >> changelog.md
        echo "New Version: $NEW_TAG" >> changelog.md

    # Step 5: Create a new branch for the release
    - name: Create release branch
      run: |
        git checkout -b release/$NEW_TAG
        git add changelog.md
        git commit -m "Update changelog for $NEW_TAG"
        git push origin release/$NEW_TAG

    # Step 6: Create a pull request from the release branch to main
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v4
      with:
        title: "Release $NEW_TAG"
        body: "This is the release pull request for $NEW_TAG"
        head: release/$NEW_TAG
        base: main
        token: ${{ secrets.GITHUB_TOKEN }}
