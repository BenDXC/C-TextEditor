name: C Build, Lint, Test, and Analyze

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint-and-build:
    runs-on: ubuntu-latest  # Use Ubuntu as the runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      # Cache dependencies (e.g., apt-get packages)
      - name: Cache apt dependencies
        uses: actions/cache@v4
        with:
          path: /tmp/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('**/main.c') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang-format cppcheck valgrind lizard doxygen cpplint lcov

      # Call reusable workflow for linting, code analysis, and formatting
      - name: Run linting and static analysis
        uses: ./.github/workflows/ci-lint.yml  # Reusable workflow call

      # Compile code with coverage flags
      - name: Compile code with coverage flags
        run: gcc -fprofile-arcs -ftest-coverage -o my_program main.c

      # Run tests and generate coverage
      - name: Run tests and generate coverage
        run: |
          ./run_tests  # Ensure your tests are instrumented for coverage
          lcov --capture --directory . --output-file coverage.info

      - name: Upload code coverage report as artifact
        uses: actions/upload-artifact@v4  # Upload coverage info as artifact
        with:
          name: coverage-report
          path: coverage.info

      # Generate documentation with Doxygen
      - name: Generate documentation with Doxygen
        run: |
          doxygen Doxyfile  # Ensure you have a Doxyfile configuration for your project

      # Run cpplint (style checking)
      - name: Run cpplint for code style
        run: |
          cpplint --filter=-whitespace/line_length *.c *.h

      # (Optional) Run unit tests if available
      - name: Run unit tests (optional)
        run: ./run_tests  # Adjust based on your test runner or framework
